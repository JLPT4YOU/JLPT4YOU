# üéØ K·∫ø Ho·∫°ch T√≠ch H·ª£p AI T·∫°o B√†i T·∫≠p JLPT

## üìã T·ªïng Quan D·ª± √Ån

### M·ª•c Ti√™u
T√≠ch h·ª£p AI (Google Gemini) v√†o trang `/study/practice` ƒë·ªÉ t·ª± ƒë·ªông sinh b√†i t·∫≠p JLPT theo level, v·ªõi architecture t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t server.

### Nguy√™n T·∫Øc Thi·∫øt K·∫ø
- **üîí Privacy First**: C√¢u tr·∫£ l·ªùi c·ªßa user l∆∞u tr√™n localStorage (kh√¥ng l√™n server)
- **‚òÅÔ∏è Cloud Storage**: B·ªô ƒë·ªÅ ƒë∆∞·ª£c AI sinh ra l∆∞u tr√™n Supabase ƒë·ªÉ t√°i s·ª≠ d·ª•ng
- **‚ö° Performance**: Gi·∫£m t·∫£i server b·∫±ng c√°ch ph√¢n t√°n data storage
- **üé® User Experience**: Tr·∫£i nghi·ªám m∆∞·ª£t m√†, realtime feedback

## üèóÔ∏è Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     USER BROWSER                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  localStorage:                                          ‚îÇ
‚îÇ  - User answers (ƒë√°p √°n user ch·ªçn)                      ‚îÇ
‚îÇ  - Correct/Incorrect status (ƒë√∫ng/sai)                  ‚îÇ
‚îÇ  - Personal progress (ti·∫øn ƒë·ªô c√° nh√¢n)                  ‚îÇ
‚îÇ  - Practice history (l·ªãch s·ª≠ l√†m b√†i)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                         ‚Üï API                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                    NEXT.JS SERVER                        ‚îÇ
‚îÇ  - Generate exercises via Gemini AI                     ‚îÇ
‚îÇ  - Save generated sets to Supabase                      ‚îÇ
‚îÇ  - Fetch existing exercise sets                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                         ‚Üï Database                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                      SUPABASE                           ‚îÇ
‚îÇ  Tables:                                                ‚îÇ
‚îÇ  - exercise_sets (b·ªô ƒë·ªÅ AI ƒë√£ sinh)                     ‚îÇ
‚îÇ  - exercise_templates (m·∫´u c√¢u h·ªèi)                     ‚îÇ
‚îÇ  - vocabulary/grammar (data g·ªëc)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üíæ Data Storage Strategy

### 1. **Supabase (Server)**
L∆∞u tr·ªØ c√°c data c√¥ng khai, c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng:
- ‚úÖ B·ªô ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c AI generate
- ‚úÖ Vocabulary/Grammar database
- ‚úÖ Exercise templates
- ‚úÖ Statistics t·ªïng quan (kh√¥ng personal)

### 2. **LocalStorage (Client)**
L∆∞u tr·ªØ data c√° nh√¢n c·ªßa t·ª´ng user:
- ‚úÖ C√¢u tr·∫£ l·ªùi user ƒë√£ ch·ªçn
- ‚úÖ K·∫øt qu·∫£ ƒë√∫ng/sai
- ‚úÖ Progress tracking c√° nh√¢n
- ‚úÖ L·ªãch s·ª≠ l√†m b√†i
- ‚úÖ User preferences

### T√≠nh Kh·∫£ Thi: ‚úÖ **HO√ÄN TO√ÄN KH·∫¢ THI**

#### ∆Øu ƒëi·ªÉm:
1. **Gi·∫£m t·∫£i server**: Kh√¥ng ph·∫£i l∆∞u h√†ng tri·ªáu record c√¢u tr·∫£ l·ªùi
2. **Privacy**: Data c√° nh√¢n user kh√¥ng l√™n server
3. **Performance**: LocalStorage truy c·∫≠p nhanh, kh√¥ng c·∫ßn network
4. **Cost-effective**: Ti·∫øt ki·ªám storage v√† bandwidth Supabase
5. **Offline capability**: User c√≥ th·ªÉ xem l·∫°i b√†i ƒë√£ l√†m offline

#### Nh∆∞·ª£c ƒëi·ªÉm v√† gi·∫£i ph√°p:
- **Cross-device sync**: Kh√¥ng sync gi·ªØa devices ‚Üí Gi·∫£i ph√°p: Optional cloud backup
- **Data loss**: M·∫•t data khi clear browser ‚Üí Gi·∫£i ph√°p: Export/Import feature
- **Storage limit**: LocalStorage gi·ªõi h·∫°n 5-10MB ‚Üí Gi·∫£i ph√°p: Rotation policy

## üìä Database Schema

### Supabase Tables

```sql
-- 1. B·∫£ng l∆∞u b·ªô ƒë·ªÅ AI ƒë√£ generate
CREATE TABLE exercise_sets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  level VARCHAR(10) NOT NULL, -- n5, n4, n3, n2, n1
  type VARCHAR(50) NOT NULL, -- vocabulary, grammar, reading, kanji
  questions JSONB NOT NULL, -- Array of questions
  metadata JSONB, -- Additional info (difficulty, tags, etc)
  generated_by VARCHAR(100), -- AI model used
  usage_count INTEGER DEFAULT 0, -- Track popularity
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Index for fast queries
CREATE INDEX idx_exercise_sets_level_type ON exercise_sets(level, type);
CREATE INDEX idx_exercise_sets_created_at ON exercise_sets(created_at DESC);

-- 2. Vocabulary/Grammar source data
CREATE TABLE study_materials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  level VARCHAR(10) NOT NULL,
  type VARCHAR(50) NOT NULL,
  content JSONB NOT NULL,
  tags TEXT[],
  created_at TIMESTAMP DEFAULT NOW()
);

-- 3. Statistics (anonymous)
CREATE TABLE exercise_statistics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  exercise_set_id UUID REFERENCES exercise_sets(id),
  difficulty_rating DECIMAL(3,2), -- Average difficulty
  completion_rate DECIMAL(3,2), -- % users completing
  average_score DECIMAL(3,2), -- Average score
  total_attempts INTEGER DEFAULT 0,
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### LocalStorage Structure

```javascript
// LocalStorage keys and structure
const STORAGE_KEYS = {
  // User practice data
  PRACTICE_HISTORY: 'jlpt_practice_history',
  USER_ANSWERS: 'jlpt_user_answers',
  PROGRESS: 'jlpt_progress',
  SETTINGS: 'jlpt_practice_settings'
};

// Example data structures
const practiceHistory = {
  sessions: [
    {
      id: 'session_123',
      exerciseSetId: 'uuid_from_supabase',
      level: 'n5',
      type: 'vocabulary',
      startedAt: '2025-01-13T10:00:00Z',
      completedAt: '2025-01-13T10:30:00Z',
      answers: [
        {
          questionId: 'q1',
          userAnswer: 'A',
          correctAnswer: 'B',
          isCorrect: false,
          timeSpent: 45 // seconds
        }
      ],
      score: 7,
      totalQuestions: 10
    }
  ]
};

const userProgress = {
  n5: {
    vocabulary: { completed: 45, total: 100, accuracy: 0.78 },
    grammar: { completed: 30, total: 80, accuracy: 0.82 }
  },
  n4: { /* ... */ }
};
```

## üîÑ Data Flow

### 1. Generate New Exercise
```mermaid
sequenceDiagram
    User->>Frontend: Click "Generate Exercise"
    Frontend->>API: POST /api/study/generate
    API->>Gemini: Generate questions
    Gemini-->>API: Return questions
    API->>Supabase: Save exercise_set
    Supabase-->>API: Return set_id
    API-->>Frontend: Return exercise data
    Frontend->>LocalStorage: Initialize session
    Frontend->>User: Display questions
```

### 2. Answer Questions
```mermaid
sequenceDiagram
    User->>Frontend: Select answer
    Frontend->>LocalStorage: Save answer
    Frontend->>Frontend: Check correctness
    Frontend->>LocalStorage: Update progress
    Frontend->>User: Show feedback
```

### 3. Complete Exercise
```mermaid
sequenceDiagram
    User->>Frontend: Finish exercise
    Frontend->>LocalStorage: Save final results
    Frontend->>API: POST /api/study/statistics (anonymous)
    API->>Supabase: Update statistics
    Frontend->>User: Show results & progress
```

## üõ†Ô∏è Implementation Plan

### Phase 1: Backend Setup (2-3 days)
- [ ] Create Supabase tables
- [ ] Setup API routes:
  - `POST /api/study/generate` - Generate via AI
  - `GET /api/study/sets` - Fetch existing sets
  - `POST /api/study/statistics` - Anonymous stats
- [ ] Implement Gemini prompt engineering

### Phase 2: LocalStorage Service (1-2 days)
- [ ] Create localStorage service class
- [ ] Implement data models
- [ ] Add encryption for sensitive data
- [ ] Create backup/restore functions

### Phase 3: Frontend Components (3-4 days)
- [ ] Update `study-practice-page-content.tsx`
- [ ] Create exercise components:
  - `ExerciseGenerator`
  - `QuestionCard`
  - `AnswerSelector`
  - `ProgressTracker`
  - `ResultsSummary`
- [ ] Implement localStorage hooks

### Phase 4: Integration (2-3 days)
- [ ] Connect frontend to APIs
- [ ] Implement error handling
- [ ] Add loading states
- [ ] Create offline mode

### Phase 5: Testing & Optimization (2 days)
- [ ] Unit tests
- [ ] Integration tests
- [ ] Performance optimization
- [ ] Security audit

## üöÄ API Endpoints

### 1. Generate Exercise
```typescript
POST /api/study/generate
Request:
{
  level: "n5" | "n4" | "n3" | "n2" | "n1",
  type: "vocabulary" | "grammar" | "reading" | "kanji",
  count: number, // Number of questions
  difficulty?: "easy" | "medium" | "hard",
  tags?: string[] // Optional filtering
}

Response:
{
  setId: "uuid",
  questions: [
    {
      id: "q1",
      type: "multiple_choice",
      question: "„Åì„ÅÆÔºøÔºø„ÅØ‰Ωï„Åß„Åô„ÅãÔºü",
      options: ["Êú¨", "Ê∞¥", "Êú∫", "Ê§ÖÂ≠ê"],
      correct: 0,
      explanation: "Explanation in Vietnamese",
      tags: ["noun", "n5"],
      difficulty: "easy"
    }
  ],
  metadata: {
    generatedAt: "2025-01-13T10:00:00Z",
    model: "gemini-2.0-flash",
    totalQuestions: 10
  }
}
```

### 2. Get Exercise Sets
```typescript
GET /api/study/sets?level=n5&type=vocabulary&limit=10

Response:
{
  sets: [
    {
      id: "uuid",
      level: "n5",
      type: "vocabulary",
      questionCount: 10,
      createdAt: "2025-01-13T10:00:00Z",
      usageCount: 45,
      averageScore: 0.75
    }
  ],
  total: 100
}
```

### 3. Submit Statistics (Anonymous)
```typescript
POST /api/study/statistics
Request:
{
  setId: "uuid",
  completionTime: 300, // seconds
  score: 8,
  totalQuestions: 10,
  difficulty_feedback: 3 // 1-5 scale
}
```

## üì± Frontend Components

### Core Components Structure
```
/components/study/practice/
‚îú‚îÄ‚îÄ ExerciseGenerator.tsx    # Main container
‚îú‚îÄ‚îÄ QuestionDisplay.tsx       # Show question
‚îú‚îÄ‚îÄ AnswerOptions.tsx         # Answer choices
‚îú‚îÄ‚îÄ ProgressBar.tsx           # Progress indicator
‚îú‚îÄ‚îÄ ResultsSummary.tsx        # Final results
‚îú‚îÄ‚îÄ PracticeHistory.tsx       # Past exercises
‚îî‚îÄ‚îÄ hooks/
    ‚îú‚îÄ‚îÄ useLocalStorage.ts    # LocalStorage hook
    ‚îú‚îÄ‚îÄ useExercise.ts        # Exercise logic
    ‚îî‚îÄ‚îÄ usePracticeStats.ts   # Statistics
```

## üé® UI/UX Design

### Exercise Flow
1. **Start Screen**
   - Select level & type
   - Choose question count
   - Optional: Select difficulty

2. **Practice Screen**
   - Question display
   - Multiple choice options
   - Timer (optional)
   - Progress indicator
   - Skip/Next buttons

3. **Results Screen**
   - Score summary
   - Review answers
   - Explanations
   - Save progress
   - Share results

## üîê Security Considerations

1. **LocalStorage Security**
   - Encrypt sensitive data
   - Validate data integrity
   - Implement data expiration

2. **API Security**
   - Rate limiting for generation
   - API key validation
   - Input sanitization

3. **Privacy**
   - No personal data to server
   - Anonymous statistics only
   - GDPR compliant

## üìà Success Metrics

- **Performance**: Page load < 2s
- **Storage**: LocalStorage usage < 5MB
- **Reliability**: 99.9% uptime
- **User Experience**: > 4.5/5 rating

## üîÑ Future Enhancements

1. **Optional Cloud Sync**
   - Encrypted backup to server
   - Cross-device synchronization

2. **Advanced Features**
   - Spaced repetition algorithm
   - Adaptive difficulty
   - Custom exercise creation

3. **Social Features**
   - Leaderboards (anonymous)
   - Challenge friends
   - Share achievements

## ‚è∞ Timeline

| Phase | Duration | Start Date | End Date |
|-------|----------|------------|----------|
| Phase 1: Backend | 2-3 days | Day 1 | Day 3 |
| Phase 2: LocalStorage | 1-2 days | Day 4 | Day 5 |
| Phase 3: Frontend | 3-4 days | Day 6 | Day 9 |
| Phase 4: Integration | 2-3 days | Day 10 | Day 12 |
| Phase 5: Testing | 2 days | Day 13 | Day 14 |

**Total: 10-14 days**

## ‚úÖ Checklist Before Launch

- [ ] All APIs tested and documented
- [ ] LocalStorage fallback for errors
- [ ] Mobile responsive design
- [ ] Performance optimization
- [ ] Security audit completed
- [ ] User testing feedback incorporated
- [ ] Documentation updated
- [ ] Monitoring setup

## üéØ Conclusion

K·∫ø ho·∫°ch n√†y **HO√ÄN TO√ÄN KH·∫¢ THI** v√† mang l·∫°i nhi·ªÅu l·ª£i √≠ch:
- ‚úÖ Gi·∫£m t·∫£i server ƒë√°ng k·ªÉ
- ‚úÖ B·∫£o v·ªá privacy ng∆∞·ªùi d√πng
- ‚úÖ TƒÉng performance
- ‚úÖ Ti·∫øt ki·ªám chi ph√≠
- ‚úÖ D·ªÖ scale v√† maintain

Ready to implement! üöÄ
